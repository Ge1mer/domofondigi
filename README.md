# Умный домофон (версия на ESPHome от Ge1mer)
________________________________________
## Возможности и режимы
Управление как физической кнопкой на корпусе, так и через интеграцию с умным домом
 - Режим автоматического открытия двери (одиночный и постоянный)
 - Режим автоматического отклонения вызова
 - Режим "без звука" постоянный или на один звонок
 
Интеграция с Home Assistant

Уведомления и управление через Telegram

Настройка яркости светодиода

OTA обновления

## Кнопка и индикация
 •	Красный светодиод мигает  -- Входящий вызов
 
 •	Красный светодиод горит   -- Включен режим "отклонять всегда"
 
 •	Синий светодиод мигает    -- Подключение к WiFi или Home Assistant
 
 •	Голубой светодиод горит   -- Включен режим "без звука"
 
 •	Голубой светодиод мигает  -- Включен режим "без звука один раз"
 
 •	Зеленый светодиод мигает  -- Включен режим "открыть дверь один раз"
 
 •	Зеленый светодиод горит   -- Включен режим "открывать дверь всегда"
 
 •	Одиночное нажатие кнопки
   -Нет входящего вызова - меняет режим автоматического открытия или отклонения (открыть один раз по первому нажатию, постоянное открытие по второму, отклонение по третьему)
   -Входящий звонок - откроет дверь
   
•	Двойное нажатие кнопки
   -Если нет входящего звонка, меняет режимы "без звука" и "без звука один раз"
   
•	Долгое нажатие кнопкb
   -Нет входящего вызова - выключит режим автоматического открытия или отклонения и режимы "без звука"
   -Входящий звонок - отклонит вызов
   
## Настраиваемые параметры
•	Delay Before Answer - время, которое пройдет между обнаружением вызова и эмуляцией поднятия трубки (в режиме автоматического открытия), по-умолчанию 400 мс

•	Answer On Time - сколько времени пройдет в режиме эмуляции поднятой трубки перед открытием двери, по-умолчанию 1000 мс

•	Open On Time - время, которое будет эмулироваться нажатие кнопки открытия, по-умолчанию 300 мс
	
•	Delay After Open - сколько времени пройдет в режиме эмуляции поднятой трубки после нажатия кнопки открытия и перед сбросом звонка, по умолчанию 500 мс

## Подключение
1.	Аккуратно вскройте трубку. Подключите входную линию к клеммам Line+ и Line- соблюдая полярность.

2.	С помощью джамперов выставьте номер квартиры. У каждого джампера подписан вес. Номер квартиры складывается из суммы весов включенных джамперов.

На фотографии установлены джамперы 1-2-4-8-16-32, в сумме даёт 63, это и есть номер квартиры.

3.	Подключите питание через разъёмы power+/power-. Подать можно от 3.5 до 16 вольт, но надо помнить, что при напряжении более 5 вольт плата будет греться.

При правильном подключении при подаче питания на трубке должен начать моргать синим светодиод.

Подключение к Home Assistant

При первом включении через 1 минуту плата создает точку доступа Domofon. Подключаемся к ней, используя пароль 1234567890. При этом, если это телефон, то он может 
ругаться что данная сеть не имеет подключения интернет. Нажимаем кнопку Использовать. Далее в браузере открываем страницу по адресу 192.168.4.1

 
На данной странице выбираем свою сеть WiFi вводим свой пароль и нажимаем кнопку Save. После этого плата перезагружается и подключается к вашему WiFi. Home assistant обычно обнаруживает подключение автоматически. Если не обнаружил, то можно подключить через интеграции. Пароль для интеграции esphome
При принятии или отклонении вызова в Home Assistant обновляется сенсор Domofon Action. Возможные значения:

•	none – значение по-умолчанию

•	open_sw – открыт программно

•	open_hw – открыт аппаратной кнопкой

•	open_auto – открыт автоматически

•	reject_sw – отклонен программно

•	reject_hw – отклонен аппаратной кнопкой

•	reject_auto – отклонен автоматически

## Конфигурация и прошивка
1.	Заполните настройки WiFi в файле domofondig.yaml
2.	Используйте ESPHome для компиляции и загрузки прошивки
## Уведомления в Telegram через Home Assistant
Положите этот файл в /config/packages/domofon.yaml и исправьте используемые сервисы в автоматизации.
## Замена интеграции с Home Assistant на MQTT
1.	Закомментируйте раздел API в файле domofondig.yaml
2.	Раскомментируйте раздел MQTT в файле domofondig.yaml
3.	Заполните настройки MQTT в файле domofondig.yaml
## Интеграция умного домофона со SprutHub
1.	Замените интеграцию с Home Assistant на MQTT, как описано в предыдущем разделе. В качестве IP-адреса MQTT-брокера используйте IP-адрес SprutHub-а, порт 44444, логин и пароль оставьте пустыми.
2.	В интерфейсе SprutHub заходим в раздел контроллеры, и запускаем поиск в контроллере MQTT. Обнаруживается устройство Домофон. Настройки таймингов находятся в разделе Параметры акссесуара.

## Ищем проблемы (если после подключения что-то не заработало)
1.	Если панель домофона на улице показывает ошибку, вероятно перепутана полярность входящих проводов, попробуйте поменять.
2.	При недостаточной громкости в трубке, можно подрегулировать подстроечный резистор на плате.
3.	Если указанные действия ни к чему не привели - стоит обратиться за помощью в чат в Telegram.

